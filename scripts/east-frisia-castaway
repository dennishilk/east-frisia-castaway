#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEFAULT_REPO_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"
PINNED_REPO_DIR="__CASTAWAY_REPO_DIR__"

if [[ -n "${CASTAWAY_REPO_DIR:-}" ]] && [[ -f "${CASTAWAY_REPO_DIR}/main.py" ]]; then
  REPO_DIR="${CASTAWAY_REPO_DIR}"
elif [[ "${PINNED_REPO_DIR}" != "__CASTAWAY_REPO_DIR__" ]] && [[ -f "${PINNED_REPO_DIR}/main.py" ]]; then
  REPO_DIR="${PINNED_REPO_DIR}"
elif [[ -f "${DEFAULT_REPO_DIR}/main.py" ]]; then
  REPO_DIR="${DEFAULT_REPO_DIR}"
else
  echo "Unable to locate East Frisia Castaway repository directory." >&2
  exit 1
fi

if [[ $# -eq 0 ]] && [[ -n "${XSCREENSAVER_WINDOW:-}" ]]; then
  set -- --window-id "${XSCREENSAVER_WINDOW}"
fi

exec python3 "${REPO_DIR}/main.py" "$@"
